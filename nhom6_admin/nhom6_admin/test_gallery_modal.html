<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Gallery Modal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        .gallery-item { position: relative; background: #f8f9fa; }
        .gallery-item .btn-remove-gallery { padding: 2px 6px; }
        .gallery-item img { object-fit: cover; }
        .modal-gallery-item { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Test Gallery Modal</h2>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#galleryImageModal">
            <i class="fas fa-plus mr-1"></i>Thêm ảnh phụ
        </button>
        
        <div id="galleryContainer" class="mt-3"></div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="galleryImageModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-images mr-2"></i>Quản lý ảnh phụ</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="modalGalleryList" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted text-center" id="emptyMessage">Chưa có ảnh nào. Hãy thêm ảnh bên dưới.</p>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center mb-3">
                        <img id="galleryPreview" src="https://via.placeholder.com/300x300?text=Preview" 
                             class="img-fluid rounded" style="max-height: 200px;">
                    </div>
                    
                    <ul class="nav nav-tabs nav-justified mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="modal-upload-tab" data-toggle="tab" href="#modalUploadTab" role="tab">
                                <i class="fas fa-upload mr-1"></i>Upload file
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="modal-url-tab" data-toggle="tab" href="#modalUrlTab" role="tab">
                                <i class="fas fa-link mr-1"></i>Nhập URL
                            </a>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="modalUploadTab" role="tabpanel">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="modalGalleryFile" accept="image/*">
                                <label class="custom-file-label" for="modalGalleryFile">Chọn ảnh</label>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="modalUrlTab" role="tabpanel">
                            <input type="text" class="form-control" id="modalGalleryUrl" placeholder="https://example.com/image.jpg">
                            <small class="text-muted d-block mt-2">Nhập URL hình ảnh từ internet</small>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-success btn-block mt-3" id="btnAddToModalList">
                        <i class="fas fa-plus mr-1"></i>Thêm vào danh sách
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="btnUpdateGallery">
                        <i class="fas fa-check mr-1"></i>Cập nhật ảnh phụ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <script>
        $(document).ready(function () {
            let galleryImageCounter = 0;
            let modalGalleryImages = [];
            let pendingGalleryFile = null;
            let pendingGalleryUrl = '';
            
            console.log('[Test] Script loaded');
            
            // Preview gallery file in modal
            $('#modalGalleryFile').change(function() {
                var file = this.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = e => {
                        $('#galleryPreview').attr('src', e.target.result);
                        pendingGalleryFile = file;
                        pendingGalleryUrl = '';
                    };
                    reader.readAsDataURL(file);
                    $(this).next('.custom-file-label').html(file.name);
                    $('#modalGalleryUrl').val('');
                    console.log('[Test] File selected:', file.name);
                }
            });
            
            // Preview gallery URL in modal
            $('#modalGalleryUrl').on('input change paste', function() {
                var url = $(this).val().trim();
                console.log('[Test] URL input event:', url);
                
                pendingGalleryUrl = url;
                pendingGalleryFile = null;
                
                if (url) {
                    $('#galleryPreview').attr('src', url);
                    $('#modalGalleryFile').val('');
                    $('#modalGalleryFile').next('.custom-file-label').html('Chọn ảnh');
                    console.log('[Test] Preview updated, pendingGalleryUrl:', pendingGalleryUrl);
                } else {
                    $('#galleryPreview').attr('src', 'https://via.placeholder.com/300x300?text=Preview');
                }
            });
            
            $('#modalGalleryUrl').on('blur', function() {
                var url = $(this).val().trim();
                pendingGalleryUrl = url;
                console.log('[Test] URL blur, pendingGalleryUrl:', pendingGalleryUrl);
            });
            
            // Tab switch
            $('#modal-url-tab').on('shown.bs.tab', function() {
                var url = $('#modalGalleryUrl').val().trim();
                pendingGalleryUrl = url;
                if (url) {
                    $('#galleryPreview').attr('src', url);
                    console.log('[Test] Tab switched, pendingGalleryUrl:', pendingGalleryUrl);
                }
            });
            
            // Reset modal
            $('#galleryImageModal').on('show.bs.modal', function() {
                modalGalleryImages = [];
                renderModalGalleryList();
                resetModalInputs();
            });
            
            function resetModalInputs() {
                $('#galleryPreview').attr('src', 'https://via.placeholder.com/300x300?text=Preview');
                $('#modalGalleryFile').val('');
                $('#modalGalleryUrl').val('');
                $('.custom-file-label').html('Chọn ảnh');
                pendingGalleryFile = null;
                pendingGalleryUrl = '';
                $('#modal-upload-tab').tab('show');
            }
            
            function renderModalGalleryList() {
                console.log('[Test] Rendering list, count:', modalGalleryImages.length);
                
                if (modalGalleryImages.length === 0) {
                    $('#modalGalleryList').html('<p class="text-muted text-center">Chưa có ảnh nào. Hãy thêm ảnh bên dưới.</p>');
                    return;
                }
                
                let html = '';
                modalGalleryImages.forEach((img, idx) => {
                    const displayName = img.name || img.url || 'Image ' + (idx + 1);
                    html += `
                        <div class="modal-gallery-item mb-2 p-2 border rounded" data-index="${idx}">
                            <div class="d-flex align-items-center">
                                <img src="${img.preview}" class="img-thumbnail mr-2" style="max-height: 60px; max-width: 60px;">
                                <div class="flex-grow-1">
                                    <small class="text-muted">${displayName}</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger btn-remove-modal-gallery ml-2" data-index="${idx}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                $('#modalGalleryList').html(html);
                console.log('[Test] List rendered');
            }
            
            // Add to list
            $('#btnAddToModalList').click(function() {
                console.log('[Test] === Add clicked ===');
                console.log('[Test] pendingGalleryFile:', pendingGalleryFile);
                console.log('[Test] pendingGalleryUrl:', pendingGalleryUrl);
                
                var directUrl = $('#modalGalleryUrl').val().trim();
                console.log('[Test] Direct URL:', directUrl);
                
                if (!pendingGalleryUrl && directUrl) {
                    pendingGalleryUrl = directUrl;
                    console.log('[Test] Using direct URL');
                }
                
                if (!pendingGalleryFile && !pendingGalleryUrl) {
                    alert('Vui lòng chọn ảnh hoặc nhập URL!');
                    return;
                }
                
                if (pendingGalleryFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        modalGalleryImages.push({
                            type: 'file',
                            file: pendingGalleryFile,
                            preview: e.target.result,
                            name: pendingGalleryFile.name
                        });
                        console.log('[Test] File added, total:', modalGalleryImages.length);
                        renderModalGalleryList();
                        resetModalInputs();
                        toastr.success('Đã thêm ảnh!');
                    };
                    reader.readAsDataURL(pendingGalleryFile);
                } else if (pendingGalleryUrl) {
                    modalGalleryImages.push({
                        type: 'url',
                        url: pendingGalleryUrl,
                        preview: pendingGalleryUrl,
                        name: pendingGalleryUrl
                    });
                    console.log('[Test] URL added, total:', modalGalleryImages.length);
                    renderModalGalleryList();
                    resetModalInputs();
                    toastr.success('Đã thêm ảnh!');
                }
            });
            
            // Remove from list
            $(document).on('click', '.btn-remove-modal-gallery', function() {
                const index = $(this).data('index');
                modalGalleryImages.splice(index, 1);
                renderModalGalleryList();
            });
            
            // Update gallery
            $('#btnUpdateGallery').click(function() {
                $('#galleryContainer').empty();
                
                modalGalleryImages.forEach((img, idx) => {
                    const index = galleryImageCounter++;
                    const displayName = img.name || img.url;
                    const imageHtml = `
                        <div class="gallery-item mb-2 p-2 border rounded">
                            <div class="d-flex align-items-center">
                                <img src="${img.preview}" class="img-thumbnail mr-2" style="max-height: 60px;">
                                <small>${displayName}</small>
                            </div>
                        </div>
                    `;
                    $('#galleryContainer').append(imageHtml);
                });
                
                $('#galleryImageModal').modal('hide');
                toastr.success('Đã cập nhật ' + modalGalleryImages.length + ' ảnh!');
            });
        });
    </script>
</body>
</html>
