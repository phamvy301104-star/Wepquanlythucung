@{
    ViewData["Title"] = "Quản lý danh mục";
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1"><i class="fas fa-folder text-primary mr-2"></i>Quản lý danh mục</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard", new { area = "Admin" })">Dashboard</a></li>
                <li class="breadcrumb-item active">Danh mục</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="@Url.Action("Create")" class="btn btn-primary">
            <i class="fas fa-plus mr-1"></i> Thêm danh mục
        </a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle mr-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
    </div>
}

<!-- Categories Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list mr-2"></i>Danh sách danh mục</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="categoriesTable" class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th style="width: 50px">#</th>
                        <th style="width: 80px">Hình</th>
                        <th>Tên danh mục</th>
                        <th>Mô tả</th>
                        <th style="width: 100px">Sản phẩm</th>
                        <th style="width: 80px">Thứ tự</th>
                        <th style="width: 100px">Trạng thái</th>
                        <th style="width: 120px">Thao tác</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash mr-2"></i>Xác nhận xóa</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Bạn có chắc chắn muốn xóa danh mục <strong id="deleteName"></strong>?</p>
                <div id="productWarning" class="alert alert-warning d-none">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="productWarningText"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash mr-1"></i>Xóa
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>

<script>
    var table;
    var deleteId;

    $(document).ready(function () {
        table = $('#categoriesTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '@Url.Action("GetData")',
                type: 'GET',
                data: function (d) {
                    d.search = d.search.value;
                }
            },
            columns: [
                {
                    data: null, orderable: false,
                    render: function (data, type, row, meta) {
                        return meta.row + meta.settings._iDisplayStart + 1;
                    }
                },
                {
                    data: 'imageUrl', orderable: false,
                    render: function (data) {
                        var src = data || 'https://via.placeholder.com/60?text=No';
                        return '<img src="' + src + '" class="img-thumbnail" style="width:60px;height:60px;object-fit:cover;">';
                    }
                },
                {
                    data: 'name',
                    render: function (data) {
                        return '<strong>' + data + '</strong>';
                    }
                },
                {
                    data: 'description',
                    render: function (data) {
                        if (!data) return '<span class="text-muted">-</span>';
                        return data.length > 50 ? data.substring(0, 50) + '...' : data;
                    }
                },
                {
                    data: 'productCount',
                    render: function (data) {
                        return '<span class="badge badge-info">' + data + '</span>';
                    }
                },
                { data: 'displayOrder' },
                {
                    data: 'isActive', orderable: false,
                    render: function (data, type, row) {
                        var checked = data ? 'checked' : '';
                        return '<div class="custom-control custom-switch">' +
                            '<input type="checkbox" class="custom-control-input toggle-active" id="active_' + row.id + '" data-id="' + row.id + '" ' + checked + '>' +
                            '<label class="custom-control-label" for="active_' + row.id + '"></label></div>';
                    }
                },
                {
                    data: null, orderable: false,
                    render: function (data, type, row) {
                        return '<div class="btn-group btn-group-sm">' +
                            '<a href="@Url.Action("Edit")/' + row.id + '" class="btn btn-warning" title="Sửa"><i class="fas fa-edit"></i></a>' +
                            '<button type="button" class="btn btn-danger btn-delete" data-id="' + row.id + '" data-name="' + row.name + '" title="Xóa"><i class="fas fa-trash"></i></button>' +
                            '</div>';
                    }
                }
            ],
            order: [[5, 'asc']],
            language: {
                processing: '<i class="fas fa-spinner fa-spin fa-2x"></i>',
                lengthMenu: 'Hiển thị _MENU_ dòng',
                zeroRecords: 'Không tìm thấy dữ liệu',
                info: 'Hiển thị _START_ - _END_ / _TOTAL_ danh mục',
                infoEmpty: 'Không có dữ liệu',
                search: 'Tìm kiếm:',
                paginate: { previous: '<i class="fas fa-angle-left"></i>', next: '<i class="fas fa-angle-right"></i>' }
            }
        });

        // Toggle Active
        $(document).on('change', '.toggle-active', function () {
            var id = $(this).data('id');
            var checkbox = $(this);
            $.post('@Url.Action("ToggleActive")/' + id, function (response) {
                if (response.success) {
                    toastr.success('Đã cập nhật!');
                } else {
                    checkbox.prop('checked', !checkbox.prop('checked'));
                    toastr.error(response.message);
                }
            });
        });

        // Delete
        var forceDelete = false;
        $(document).on('click', '.btn-delete', function () {
            deleteId = $(this).data('id');
            forceDelete = false;
            $('#deleteName').text($(this).data('name'));
            $('#deleteMessage').show();
            $('#productWarning').addClass('d-none');
            $('#confirmDelete').text('Xóa').removeClass('btn-warning').addClass('btn-danger');
            $('#deleteModal').modal('show');
        });

        $('#confirmDelete').click(function () {
            $.post('@Url.Action("Delete")/' + deleteId + '?forceDelete=' + forceDelete, function (response) {
                if (response.success) {
                    toastr.success(response.message);
                    table.ajax.reload();
                    $('#deleteModal').modal('hide');
                } else if (response.requireConfirm) {
                    // Hiển thị cảnh báo có sản phẩm
                    forceDelete = true;
                    $('#deleteMessage').hide();
                    $('#productWarning').removeClass('d-none');
                    $('#productWarningText').html('<strong>Cảnh báo:</strong> ' + response.message);
                    $('#confirmDelete').html('<i class="fas fa-exclamation-triangle mr-1"></i>Xác nhận xóa').removeClass('btn-danger').addClass('btn-warning');
                } else {
                    toastr.error(response.message);
                    $('#deleteModal').modal('hide');
                }
            });
        });
    });
</script>
}
