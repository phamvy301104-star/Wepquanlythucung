@model nhom6_admin.Areas.Admin.Controllers.ProductViewModel
@{
    ViewData["Title"] = "Sửa sản phẩm";
}

@section Styles {
<style>
    .gallery-item {
        position: relative;
        background: #f8f9fa;
    }
    .gallery-item .btn-remove-gallery {
        padding: 2px 6px;
    }
    .gallery-item img {
        object-fit: cover;
    }
</style>
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1"><i class="fas fa-edit text-warning mr-2"></i>Sửa sản phẩm</h4>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard", new { area = "Admin" })">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Index")">Sản phẩm</a></li>
                <li class="breadcrumb-item active">@Model.Name</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-info">
            <i class="fas fa-eye mr-1"></i> Xem chi tiết
        </a>
        <a href="@Url.Action("Index")" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i> Quay lại
        </a>
    </div>
</div>

<form asp-action="Edit" method="post" enctype="multipart/form-data" id="productForm">
    <input type="hidden" asp-for="Id" />
    
    <div class="row">
        <!-- Main Info -->
        <div class="col-lg-8">
            <!-- Basic Info Card -->
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle mr-2"></i>Thông tin cơ bản</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="SKU" class="required"></label>
                                <input asp-for="SKU" class="form-control" placeholder="VD: SP001">
                                <span asp-validation-for="SKU" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Barcode"></label>
                                <input asp-for="Barcode" class="form-control" placeholder="Mã vạch sản phẩm">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Unit"></label>
                                <input asp-for="Unit" class="form-control" placeholder="VD: Chai, Hộp">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="Name" class="required"></label>
                        <input asp-for="Name" class="form-control" placeholder="Nhập tên sản phẩm">
                        <span asp-validation-for="Name" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="ShortDescription"></label>
                        <textarea asp-for="ShortDescription" class="form-control" rows="2" placeholder="Mô tả ngắn gọn về sản phẩm"></textarea>
                    </div>

                    <div class="form-group">
                        <label asp-for="Description"></label>
                        <textarea asp-for="Description" class="form-control summernote" rows="5"></textarea>
                    </div>
                </div>
            </div>

            <!-- Pricing Card -->
            <div class="card card-success card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-dollar-sign mr-2"></i>Giá & Tồn kho</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="OriginalPrice" class="required"></label>
                                <div class="input-group">
                                    <input asp-for="OriginalPrice" type="number" class="form-control" step="1000">
                                    <div class="input-group-append">
                                        <span class="input-group-text">đ</span>
                                    </div>
                                </div>
                                <span asp-validation-for="OriginalPrice" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="Price" class="required"></label>
                                <div class="input-group">
                                    <input asp-for="Price" type="number" class="form-control" step="1000">
                                    <div class="input-group-append">
                                        <span class="input-group-text">đ</span>
                                    </div>
                                </div>
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="DiscountPercent"></label>
                                <div class="input-group">
                                    <input asp-for="DiscountPercent" type="number" class="form-control" min="0" max="100">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label asp-for="CostPrice"></label>
                                <div class="input-group">
                                    <input asp-for="CostPrice" type="number" class="form-control" step="1000">
                                    <div class="input-group-append">
                                        <span class="input-group-text">đ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="StockQuantity"></label>
                                <input asp-for="StockQuantity" type="number" class="form-control" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="LowStockThreshold"></label>
                                <input asp-for="LowStockThreshold" type="number" class="form-control" min="0">
                                <small class="text-muted">Cảnh báo khi tồn kho dưới ngưỡng này</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Info Card -->
            <div class="card card-info card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs mr-2"></i>Thông tin bổ sung</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Weight"></label>
                                <div class="input-group">
                                    <input asp-for="Weight" type="number" class="form-control">
                                    <div class="input-group-append">
                                        <span class="input-group-text">gram</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Volume"></label>
                                <div class="input-group">
                                    <input asp-for="Volume" type="number" class="form-control">
                                    <div class="input-group-append">
                                        <span class="input-group-text">ml</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label asp-for="Origin"></label>
                                <input asp-for="Origin" class="form-control" placeholder="VD: Việt Nam, Hàn Quốc">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="Ingredients"></label>
                        <textarea asp-for="Ingredients" class="form-control" rows="3" placeholder="Thành phần sản phẩm"></textarea>
                    </div>

                    <div class="form-group">
                        <label asp-for="Usage"></label>
                        <textarea asp-for="Usage" class="form-control" rows="3" placeholder="Hướng dẫn sử dụng"></textarea>
                    </div>

                    <div class="form-group">
                        <label asp-for="Warnings"></label>
                        <textarea asp-for="Warnings" class="form-control" rows="2" placeholder="Lưu ý, cảnh báo"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Image Upload Card -->
            <div class="card card-warning card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-image mr-2"></i>Hình ảnh</h3>
                </div>
                <div class="card-body text-center">
                    <div class="image-preview mb-3" id="imagePreview">
                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <img src="@Model.ImageUrl" alt="@Model.Name" id="preview" class="img-fluid rounded" style="max-height: 250px;">
                        }
                        else
                        {
                            <img src="https://via.placeholder.com/300x300?text=Chưa+có+hình" alt="Preview" id="preview" class="img-fluid rounded" style="max-height: 250px;">
                        }
                    </div>
                    
                    <!-- Tab chọn cách upload -->
                    <ul class="nav nav-tabs nav-justified mb-3" id="imageTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="upload-tab" data-toggle="tab" href="#uploadTab" role="tab">
                                <i class="fas fa-upload mr-1"></i>Upload file
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="url-tab" data-toggle="tab" href="#urlTab" role="tab">
                                <i class="fas fa-link mr-1"></i>Nhập URL
                            </a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="imageTabContent">
                        <div class="tab-pane fade show active" id="uploadTab" role="tabpanel">
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="imageFile" name="imageFile" accept="image/*">
                                <label class="custom-file-label" for="imageFile">Chọn hình mới</label>
                            </div>
                            <small class="text-muted d-block mt-2">Hỗ trợ: JPG, PNG, GIF. Tối đa 5MB</small>
                        </div>
                        <div class="tab-pane fade" id="urlTab" role="tabpanel">
                            <input type="text" class="form-control" id="imageUrlInput" placeholder="https://example.com/image.jpg" value="@(Model.ImageUrl?.StartsWith("/uploads/") == true || Model.ImageUrl?.StartsWith("/images/") == true ? "" : Model.ImageUrl)">
                            <small class="text-muted d-block mt-2">Nhập URL hình ảnh từ internet</small>
                        </div>
                    </div>
                    <!-- Hidden input để đảm bảo URL luôn được submit -->
                    <input type="hidden" id="finalImageUrl" name="imageUrl" value="@(Model.ImageUrl?.StartsWith("/uploads/") == true || Model.ImageUrl?.StartsWith("/images/") == true ? "" : Model.ImageUrl)" />
                </div>
            </div>

            <!-- Gallery Images Card -->
            <div class="card card-info card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-images mr-2"></i>Thư viện ảnh phụ</h3>
                </div>
                <div class="card-body">
                    <div id="galleryContainer" class="mb-3">
                        <!-- Hiển thị ảnh hiện có -->
                        @if (!string.IsNullOrEmpty(Model.AdditionalImages))
                        {
                            var images = System.Text.Json.JsonSerializer.Deserialize<List<string>>(Model.AdditionalImages);
                            if (images != null)
                            {
                                int index = 0;
                                @foreach (var img in images)
                                {
                                    <div class="gallery-item mb-2 p-2 border rounded" data-index="@index">
                                        <div class="d-flex align-items-center">
                                            <img src="@img" class="img-thumbnail mr-2" style="max-height: 60px; max-width: 60px;">
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block text-truncate" style="max-width: 200px;">@img</small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-danger btn-remove-gallery ml-2">
                                                <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" name="existingGalleryImages" value="@img" />
                                </div>
                                index++;
                            }
                            }
                        }
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#galleryImageModal">
                        <i class="fas fa-plus mr-1"></i>Thêm ảnh phụ
                    </button>
                </div>
            </div>

            <!-- Category & Brand Card -->
            <div class="card card-secondary card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tags mr-2"></i>Phân loại</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="CategoryId"></label>
                        <select asp-for="CategoryId" class="form-control select2" asp-items="@(ViewBag.Categories as IEnumerable<SelectListItem>)">
                            <option value="">-- Chọn danh mục --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label asp-for="BrandId"></label>
                        <select asp-for="BrandId" class="form-control select2" asp-items="@(ViewBag.Brands as IEnumerable<SelectListItem>)">
                            <option value="">-- Chọn thương hiệu --</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card card-dark card-outline">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-toggle-on mr-2"></i>Trạng thái</h3>
                </div>
                <div class="card-body">
                    <div class="custom-control custom-switch mb-3">
                        <input asp-for="IsActive" class="custom-control-input" id="isActive">
                        <label class="custom-control-label" for="isActive">Hoạt động</label>
                    </div>

                    <div class="custom-control custom-switch mb-3">
                        <input asp-for="IsFeatured" class="custom-control-input" id="isFeatured">
                        <label class="custom-control-label" for="isFeatured">
                            <i class="fas fa-star text-warning"></i> Nổi bật
                        </label>
                    </div>

                    <div class="custom-control custom-switch mb-3">
                        <input asp-for="IsBestSeller" class="custom-control-input" id="isBestSeller">
                        <label class="custom-control-label" for="isBestSeller">
                            <i class="fas fa-fire text-danger"></i> Bán chạy
                        </label>
                    </div>

                    <div class="custom-control custom-switch">
                        <input asp-for="IsNewArrival" class="custom-control-input" id="isNewArrival">
                        <label class="custom-control-label" for="isNewArrival">
                            <i class="fas fa-sparkles text-info"></i> Hàng mới
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card bg-light">
                <div class="card-body">
                    <button type="submit" class="btn btn-warning btn-block btn-lg">
                        <i class="fas fa-save mr-2"></i>Cập nhật
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-secondary btn-block">
                        <i class="fas fa-times mr-2"></i>Hủy
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal Thêm Ảnh Phụ -->
<div class="modal fade" id="galleryImageModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-images mr-2"></i>Quản lý ảnh phụ</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Danh sách ảnh đã chọn trong modal -->
                <div id="modalGalleryList" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                    <p class="text-muted text-center" id="emptyMessage">Chưa có ảnh nào. Hãy thêm ảnh bên dưới.</p>
                </div>
                
                <hr>
                
                <h6 class="mb-3">Thêm ảnh mới</h6>
                <div class="text-center mb-3">
                    <img id="galleryPreview" src="https://via.placeholder.com/300x300?text=Preview" 
                         class="img-fluid rounded" style="max-height: 200px;">
                </div>
                
                <!-- Tab chọn cách upload -->
                <ul class="nav nav-tabs nav-justified mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="modal-upload-tab" data-toggle="tab" href="#modalUploadTab" role="tab">
                            <i class="fas fa-upload mr-1"></i>Upload file
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="modal-url-tab" data-toggle="tab" href="#modalUrlTab" role="tab">
                            <i class="fas fa-link mr-1"></i>Nhập URL
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="modalUploadTab" role="tabpanel">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="modalGalleryFile" accept="image/*">
                            <label class="custom-file-label" for="modalGalleryFile">Chọn ảnh</label>
                        </div>
                        <small class="text-muted d-block mt-2">Hỗ trợ: JPG, PNG, GIF. Tối đa 5MB</small>
                    </div>
                    <div class="tab-pane fade" id="modalUrlTab" role="tabpanel">
                        <input type="text" class="form-control" id="modalGalleryUrl" placeholder="https://example.com/image.jpg">
                        <small class="text-muted d-block mt-2">Nhập URL hình ảnh từ internet</small>
                    </div>
                </div>
                
                <button type="button" class="btn btn-success btn-block mt-3" id="btnAddToModalList">
                    <i class="fas fa-plus mr-1"></i>Thêm vào danh sách
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnUpdateGallery">
                    <i class="fas fa-save mr-1"></i>Cập nhật ảnh phụ
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<!-- Summernote -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-vi-VN.min.js"></script>

<script>
    $(document).ready(function () {
        console.log('[Product Edit] Script started');
        console.log('[Product Edit] jQuery version:', $.fn.jquery);
        console.log('[Product Edit] Select2 available:', typeof $.fn.select2);
        console.log('[Product Edit] Summernote available:', typeof $.fn.summernote);
        
        // Initialize Summernote
        $('.summernote').summernote({
            height: 200,
            lang: 'vi-VN',
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ]
        });

        // Initialize Select2
        try {
            console.log('[Product Edit] Initializing Select2...');
            $('.select2').select2({
                theme: 'bootstrap4'
            });
            console.log('[Product Edit] Select2 initialized successfully');
        } catch (error) {
            console.error('[Product Edit] Select2 init error:', error);
            alert('Lỗi khởi tạo Select2: ' + error.message);
        }

        // Gallery images management
        let galleryImageCounter = 0;
        let modalGalleryImages = []; // Store images in modal
        let pendingGalleryFile = null;
        let pendingGalleryUrl = '';
        
        // Preview gallery file in modal
        $('#modalGalleryFile').change(function() {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = e => {
                    $('#galleryPreview').attr('src', e.target.result);
                    pendingGalleryFile = file;
                    pendingGalleryUrl = '';
                };
                reader.readAsDataURL(file);
                $(this).next('.custom-file-label').html(file.name);
                $('#modalGalleryUrl').val('');
            }
        });
        
        // Preview gallery URL in modal - Fixed to always update pendingGalleryUrl
        $('#modalGalleryUrl').on('input change paste', function() {
            var url = $(this).val().trim();
            console.log('[Gallery] URL input event:', url);
            
            // Always update pendingGalleryUrl when input changes
            pendingGalleryUrl = url;
            pendingGalleryFile = null;
            
            if (url) {
                $('#galleryPreview').attr('src', url);
                $('#modalGalleryFile').val('');
                $('#modalGalleryFile').next('.custom-file-label').html('Chọn ảnh');
                console.log('[Gallery] Preview updated, pendingGalleryUrl set to:', pendingGalleryUrl);
            } else {
                $('#galleryPreview').attr('src', 'https://via.placeholder.com/300x300?text=Preview');
            }
        });
        
        // Also update on blur (when user clicks away)
        $('#modalGalleryUrl').on('blur', function() {
            var url = $(this).val().trim();
            pendingGalleryUrl = url;
            console.log('[Gallery] URL blur event, pendingGalleryUrl:', pendingGalleryUrl);
        });
        
        // Trigger preview update when switching to URL tab
        $('#modal-url-tab').on('shown.bs.tab', function() {
            var url = $('#modalGalleryUrl').val().trim();
            pendingGalleryUrl = url; // Update on tab switch
            if (url) {
                $('#galleryPreview').attr('src', url);
                console.log('[Gallery] Tab switched, URL preview updated, pendingGalleryUrl:', pendingGalleryUrl);
            }
        });
        
        // Reset modal when opened
        $('#galleryImageModal').on('show.bs.modal', function() {
            // Load existing images from main container
            modalGalleryImages = [];
            $('#galleryContainer .gallery-item').each(function() {
                const $item = $(this);
                const imgSrc = $item.find('img').attr('src');
                const imgName = $item.find('small').text();
                const fileInput = $item.find('.gallery-file-input')[0];
                const existingUrlInput = $item.find('input[name="existingGalleryImages"]').val();
                const newUrlInput = $item.find('input[name="newGalleryUrls"]').val();
                
                if (fileInput && fileInput.files.length > 0) {
                    modalGalleryImages.push({ type: 'file', file: fileInput.files[0], preview: imgSrc, name: imgName });
                } else if (existingUrlInput) {
                    modalGalleryImages.push({ type: 'url', url: existingUrlInput, preview: imgSrc, name: imgName, isExisting: true });
                } else if (newUrlInput) {
                    modalGalleryImages.push({ type: 'url', url: newUrlInput, preview: imgSrc, name: imgName, isExisting: false });
                }
            });
            
            renderModalGalleryList();
            resetModalInputs();
        });
        
        function resetModalInputs() {
            $('#galleryPreview').attr('src', 'https://via.placeholder.com/300x300?text=Preview');
            $('#modalGalleryFile').val('');
            $('#modalGalleryUrl').val('');
            $('.custom-file-label').html('Chọn ảnh');
            pendingGalleryFile = null;
            pendingGalleryUrl = '';
            $('#modal-upload-tab').tab('show');
        }
        
        function renderModalGalleryList() {
            console.log('[Gallery] ===== Rendering modal list =====');
            console.log('[Gallery] Images count:', modalGalleryImages.length);
            console.log('[Gallery] Images array:', JSON.stringify(modalGalleryImages.map(img => ({
                type: img.type,
                name: img.name || img.url,
                preview: img.preview ? img.preview.substring(0, 50) + '...' : 'none'
            }))));
            
            const container = $('#modalGalleryList');
            if (!container.length) {
                console.error('[Gallery] ERROR: #modalGalleryList not found!');
                return;
            }
            
            if (modalGalleryImages.length === 0) {
                container.html('<p class="text-muted text-center" id="emptyMessage">Chưa có ảnh nào. Hãy thêm ảnh bên dưới.</p>');
                console.log('[Gallery] Displayed empty message');
                return;
            }
            
            let html = '';
            modalGalleryImages.forEach((img, idx) => {
                const displayName = img.name || img.url || 'Image ' + (idx + 1);
                console.log(`[Gallery] Rendering image ${idx}: ${displayName}`);
                html += `
                    <div class="modal-gallery-item mb-2 p-2 border rounded bg-light" data-index="${idx}">
                        <div class="d-flex align-items-center">
                            <img src="${img.preview}" class="img-thumbnail mr-2" style="max-height: 60px; max-width: 60px; object-fit: cover;" onerror="console.error('Image load failed:', this.src)">
                            <div class="flex-grow-1">
                                <small class="text-muted d-block text-truncate" style="max-width: 300px;" title="${displayName}">${displayName}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-danger btn-remove-modal-gallery ml-2" data-index="${idx}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            container.html(html);
            console.log('[Gallery] Modal list HTML updated with', modalGalleryImages.length, 'items');
            console.log('[Gallery] ===== Render complete =====');
        }
        
        // Add image to modal list (not main form yet) - Fixed
        $('#btnAddToModalList').click(function() {
            console.log('[Gallery] ===== Add button clicked =====');
            console.log('[Gallery] pendingGalleryFile:', pendingGalleryFile);
            console.log('[Gallery] pendingGalleryUrl:', pendingGalleryUrl);
            
            // Get URL from input directly as fallback
            var directUrl = $('#modalGalleryUrl').val().trim();
            console.log('[Gallery] Direct URL from input:', directUrl);
            
            // Use direct URL if pendingGalleryUrl is empty
            if (!pendingGalleryUrl && directUrl) {
                pendingGalleryUrl = directUrl;
                console.log('[Gallery] Using direct URL, set pendingGalleryUrl to:', pendingGalleryUrl);
            }
            
            if (!pendingGalleryFile && !pendingGalleryUrl) {
                const msg = 'Vui lòng chọn ảnh hoặc nhập URL!';
                console.error('[Gallery] Error:', msg);
                if (typeof toastr !== 'undefined') {
                    toastr.warning(msg);
                } else {
                    alert(msg);
                }
                return;
            }
            
            if (pendingGalleryFile) {
                console.log('[Gallery] Adding file:', pendingGalleryFile.name);
                const reader = new FileReader();
                reader.onload = function(e) {
                    modalGalleryImages.push({
                        type: 'file',
                        file: pendingGalleryFile,
                        preview: e.target.result,
                        name: pendingGalleryFile.name
                    });
                    console.log('[Gallery] File added to array. Total:', modalGalleryImages.length);
                    console.log('[Gallery] Current array:', modalGalleryImages);
                    renderModalGalleryList();
                    resetModalInputs();
                    const successMsg = 'Đã thêm ảnh vào danh sách!';
                    if (typeof toastr !== 'undefined') {
                        toastr.success(successMsg);
                    } else {
                        alert(successMsg);
                    }
                };
                reader.readAsDataURL(pendingGalleryFile);
            } else if (pendingGalleryUrl) {
                console.log('[Gallery] Adding URL:', pendingGalleryUrl);
                modalGalleryImages.push({
                    type: 'url',
                    url: pendingGalleryUrl,
                    preview: pendingGalleryUrl,
                    name: pendingGalleryUrl,
                    isExisting: false // Mark as new URL
                });
                console.log('[Gallery] URL added to array. Total:', modalGalleryImages.length);
                console.log('[Gallery] Current array:', modalGalleryImages);
                renderModalGalleryList();
                resetModalInputs();
                const successMsg = 'Đã thêm ảnh vào danh sách!';
                if (typeof toastr !== 'undefined') {
                    toastr.success(successMsg);
                } else {
                    alert(successMsg);
                }
            }
        });
        
        // Remove image from modal list
        $(document).on('click', '.btn-remove-modal-gallery', function() {
            const index = $(this).data('index');
            modalGalleryImages.splice(index, 1);
            renderModalGalleryList();
        });
        
        // Update gallery - apply modal images to main form
        $('#btnUpdateGallery').click(function() {
            console.log('[Gallery] Update button clicked. Total images:', modalGalleryImages.length);
            
            // Clear main container
            $('#galleryContainer').empty();
            
            // Add all modal images to main form
            modalGalleryImages.forEach((img, idx) => {
                const index = galleryImageCounter++;
                console.log(`[Gallery] Adding image ${idx}:`, img.type, img.name || img.url);
                
                if (img.type === 'file') {
                    // Create container for file
                    const imageHtml = `
                        <div class="gallery-item mb-2 p-2 border rounded" data-index="${index}">
                            <div class="d-flex align-items-center">
                                <img src="${img.preview}" class="img-thumbnail mr-2" style="max-height: 60px; max-width: 60px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block text-truncate" style="max-width: 200px;">${img.name}</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger btn-remove-gallery ml-2">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <input type="file" name="galleryFiles" class="d-none gallery-file-input" data-index="${index}">
                        </div>
                    `;
                    $('#galleryContainer').append(imageHtml);
                    
                    // Store file in hidden input using DataTransfer
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(img.file);
                    const fileInput = $(`.gallery-file-input[data-index="${index}"]`)[0];
                    fileInput.files = dataTransfer.files;
                    console.log(`[Gallery] File stored in input:`, fileInput.files[0].name);
                    
                } else if (img.type === 'url') {
                    // Determine if this is existing or new URL
                    const inputName = img.isExisting ? 'existingGalleryImages' : 'newGalleryUrls';
                    const imageHtml = `
                        <div class="gallery-item mb-2 p-2 border rounded" data-index="${index}">
                            <div class="d-flex align-items-center">
                                <img src="${img.preview}" class="img-thumbnail mr-2" style="max-height: 60px; max-width: 60px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <small class="text-muted d-block text-truncate" style="max-width: 200px;">${img.url}</small>
                                </div>
                                <button type="button" class="btn btn-sm btn-danger btn-remove-gallery ml-2">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <input type="hidden" name="${inputName}" value="${img.url}">
                        </div>
                    `;
                    $('#galleryContainer').append(imageHtml);
                    console.log(`[Gallery] URL stored as ${inputName}:`, img.url);
                }
            });
            
            $('#galleryImageModal').modal('hide');
            toastr.success(`Đã cập nhật ${modalGalleryImages.length} ảnh phụ!`);
            console.log('[Gallery] Update complete');
        });
        
        // Remove gallery item from main form
        $(document).on('click', '.btn-remove-gallery', function() {
            $(this).closest('.gallery-item').remove();
        });

        // Initialize hidden field with current URL value
        var initialUrl = $('#imageUrlInput').val();
        if (initialUrl) {
            $('#finalImageUrl').val(initialUrl);
        }

        // Image preview from file - clear URL when file selected
        $('#imageFile').change(function () {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = e => $('#preview').attr('src', e.target.result);
                reader.readAsDataURL(file);
                $(this).next('.custom-file-label').html(file.name);
                $('#imageUrlInput').val('');
                $('#finalImageUrl').val(''); // Clear hidden URL field
            }
        });

        // Image preview from URL - sync to hidden field
        $('#imageUrlInput').on('input change blur paste keyup', function () {
            var url = $(this).val().trim();
            $('#finalImageUrl').val(url); // Always sync to hidden field
            console.log('URL input changed:', url);
            console.log('Hidden field value:', $('#finalImageUrl').val());
            if (url) {
                $('#preview').attr('src', url);
                $('#imageFile').val('');
                $('.custom-file-label').html('Chọn hình mới');
            }
        });
        
        // Ensure URL is synced before form submit
        $('#productForm').on('submit', function() {
            var urlVal = $('#imageUrlInput').val().trim();
            $('#finalImageUrl').val(urlVal);
            console.log('=== FORM SUBMIT ===');
            console.log('imageUrlInput value:', urlVal);
            console.log('finalImageUrl value:', $('#finalImageUrl').val());
            console.log('imageFile value:', $('#imageFile').val());
            
            // Debug: Show all form data
            var formData = new FormData(this);
            console.log('Form data:');
            for (var pair of formData.entries()) {
                if (pair[0] === 'imageUrl' || pair[0] === 'imageFile') {
                    console.log('  ' + pair[0] + ': ' + pair[1]);
                }
            }
        });

        // Auto calculate discount
        $('#OriginalPrice, #Price').change(function () {
            var original = parseFloat($('#OriginalPrice').val()) || 0;
            var price = parseFloat($('#Price').val()) || 0;
            if (original > 0 && price > 0 && original > price) {
                var discount = Math.round((original - price) / original * 100);
                $('#DiscountPercent').val(discount);
            }
        });

        // Form validation
        $('#productForm').submit(function (e) {
            var price = parseFloat($('#Price').val()) || 0;
            var original = parseFloat($('#OriginalPrice').val()) || 0;

            if (price > original) {
                e.preventDefault();
                toastr.error('Giá bán không được lớn hơn giá gốc!');
                return false;
            }
        });
    });
</script>
}
